name: Run lint and tests

on:
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - module: River Core
            path: :core
            runner: macos-latest
          - module: AMQP
            path: :connector:connector-amqp
            containers: rabbitmq
          - module: Apache Kafka
            path: :connector:connector-apache:connector-apache-kafka
            containers: zookeeper kafka
          - module: AWS Lambda
            path: :connector:connector-aws:connector-aws-lambda
            containers: localstack
          - module: AWS S3
            path: :connector:connector-aws:connector-aws-s3
            containers: localstack
          - module: AWS SES
            path: :connector:connector-aws:connector-aws-ses
            containers: localstack
          - module: AWS SNS
            path: :connector:connector-aws:connector-aws-sns
            containers: localstack
          - module: AWS SQS
            path: :connector:connector-aws:connector-aws-sqs
            containers: localstack
          - module: Azure Queue Storage
            path: :connector:connector-azure:connector-azure-queue-storage
            containers: azurite
          - module: Console
            path: :connector:connector-console
          - module: Elasticsearch
            path: :connector:connector-elasticsearch
            containers: elasticsearch
          - module: File
            path: :connector:connector-file
          - module: Formats (JSON, CSV, Positional Flat Line)
            path: :connector:connector-format
            runner: macos-latest
          - module: FTP
            path: :connector:connector-ftp
          - module: GitHub
            path: :connector:connector-github
          - module: Google Drive
            path: :connector:connector-google:connector-google-drive
          - module: HTTP
            path: :connector:connector-http
          - module: JMS
            path: :connector:connector-jms
          - module: MongoDB
            path: :connector:connector-mongodb
            containers: mongodb
          - module: OpenAI
            path: :connector:connector-openai
          - module: JDBC
            path: :connector:connector-rdbms:connector-rdbms-jdbc
            containers: postgresql
          - module: R2DBC
            path: :connector:connector-rdbms:connector-rdbms-r2dbc
          - module: Debezium
            path: :connector:connector-red-hat:connector-red-hat-debezium
            containers: mysql
          - module: Redis
            path: :connector:connector-redis
            containers: redis

    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        uses: River-Kt/river/.github/workflows/test-module.yml@ref
        with:
          module: ${{ matrix.module }}
          path: ${{ matrix.path }}
          runner: ${{ matrix.runner }}
